Sub Format_And_Group_Sheet()

    Dim ws As Worksheet
    Set ws = ActiveSheet

    Dim lastRow As Long
    Dim r As Long
    Dim cb As Long, ct As Long

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    '--------------------------------------------------
    ' Freeze panes at row 8
    '--------------------------------------------------
    ws.Activate
    ws.Range("A9").Select
    ActiveWindow.FreezePanes = True

    '--------------------------------------------------
    ' Find last row with data in Column A
    '--------------------------------------------------
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row

    '--------------------------------------------------
    ' Loop Column A to find grouping ranges
    ' Group rows between:
    ' "(Balance forward" and "Totals for"
    '--------------------------------------------------
    cb = 0
    ct = 0

    For r = 1 To lastRow

        If InStr(1, ws.Cells(r, "A").Value, "(Balance forward", vbTextCompare) > 0 Then
            cb = r
        End If

        If InStr(1, ws.Cells(r, "A").Value, "Totals for", vbTextCompare) > 0 Then
            ct = r

            If cb > 0 And ct > cb + 1 Then
                ws.Rows((cb + 1) & ":" & (ct - 1)).Group
            End If

            cb = 0
            ct = 0
        End If

    Next r

    '--------------------------------------------------
    ' Collapse all outline groups
    '--------------------------------------------------
    ws.Outline.ShowLevels RowLevels:=1

    '--------------------------------------------------
    ' Apply comma style formatting
    '--------------------------------------------------
    ws.Columns("I:I").Style = "Comma"
    ws.Columns("J:J").Style = "Comma"
    ws.Columns("K:K").Style = "Comma"
    ws.Columns("O:O").Style = "Comma"

    '--------------------------------------------------
    ' Apply fill color from M1 to M(lastRow)
    '--------------------------------------------------
    ws.Range("M1:M" & lastRow).Interior.Color = -0.0999786370433668

    '--------------------------------------------------
    ' Find specific "Totals for X" rows (no looping past first match)
    '--------------------------------------------------

    ' Totals for 1 → Accounts Receivable
    For r = 1 To lastRow
        If InStr(1, ws.Cells(r, "A").Value, "Totals for 1", vbTextCompare) > 0 Then
            ws.Cells(r, "N").Value = "Accounts Receivable:"
            Exit For
        End If
    Next r

    ' Totals for 2 → Accounts Payable
    For r = 1 To lastRow
        If InStr(1, ws.Cells(r, "A").Value, "Totals for 2", vbTextCompare) > 0 Then
            ws.Cells(r, "N").Value = "Accounts Payable:"
            Exit For
        End If
    Next r

    ' Totals for 5 → Expenses
    For r = 1 To lastRow
        If InStr(1, ws.Cells(r, "A").Value, "Totals for 5", vbTextCompare) > 0 Then
            ws.Cells(r, "N").Value = "Expenses:"
            Exit For
        End If
    Next r

    Application.ScreenUpdating = True
    Application.EnableEvents = True

End Sub
